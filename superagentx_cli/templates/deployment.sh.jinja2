#!/bin/bash
set -e
set -u

echo "ğŸš€ Starting deployment of {{ app_name }}..."

PROJECT_PATH="{{ app_path }}"
VENV_PATH="{{ app_path }}/.venv"
CONF_SRC="{{ app_path }}/{{ app_name }}/{{ app_name }}.conf"

###############################################
#  STEP 1 â€” Install uv (if missing)
###############################################

if ! command -v uv &>/dev/null; then
    echo "ğŸ“¦ Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    export PATH="$HOME/.local/bin:$PATH"
fi

echo "âœ” uv available at: $(command -v uv)"

###############################################
#  STEP 2 â€” Create venv (uv venv)
###############################################

if [[ ! -d "$VENV_PATH" ]]; then
    echo "ğŸ Creating virtual environment using uv..."
    uv venv "$VENV_PATH"
else
    echo "ğŸ venv already exists."
fi

# Activate environment
source "$VENV_PATH/bin/activate"

###############################################
#  STEP 3 â€” Install dependencies from pyproject
###############################################

echo "ğŸ“¦ Installing dependencies via uv..."
cd "$PROJECT_PATH"
uv sync --reinstall

echo "âœ” Python environment ready."
##############################
#  STEP 4 â€” Supervisor config
##############################

echo "ğŸ“ Copying Supervisor config..."
SUPERVISOR_DIR="/etc/supervisor/conf.d"
cp "$CONF_SRC" "$SUPERVISOR_DIR/{{ app_name }}.conf"

echo "ğŸ‰ {{ app_name }} Setup Completed Successfully!"
