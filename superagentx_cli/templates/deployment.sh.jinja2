#!/bin/bash
set -e
set -u

echo "ğŸš€ Starting deployment of {{ app_name }}..."

PROJECT_PATH="{{ app_path }}"
VENV_PATH="{{ app_path }}/.venv"
CONF_SRC="{{ app_path }}/{{ app_name }}/{{ app_name }}.conf"

###############################################
#  Detect Linux distribution
###############################################

OS="unknown"

if [[ -f /etc/debian_version ]]; then
    OS="debian"
elif [[ -f /etc/redhat-release ]]; then
    OS="rhel"
else
    echo "âŒ Unsupported Linux distribution."
    exit 1
fi

echo "ğŸ–¥ Detected Linux OS: $OS"

###############################################
#  STEP 1 â€” Install uv (if missing)
###############################################

if ! command -v uv &>/dev/null; then
    echo "ğŸ“¦ Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    export PATH="$HOME/.local/bin:$PATH"
fi

echo "âœ” uv available at: $(command -v uv)"

###############################################
#  STEP 2 â€” Create venv (uv venv)
###############################################

if [[ ! -d "$VENV_PATH" ]]; then
    echo "ğŸ Creating virtual environment using uv..."
    uv venv "$VENV_PATH"
else
    echo "ğŸ venv already exists."
fi

# Activate environment
source "$VENV_PATH/bin/activate"

###############################################
#  STEP 3 â€” Install dependencies from pyproject
###############################################

echo "ğŸ“¦ Installing dependencies via uv..."
cd "$PROJECT_PATH"
uv sync --reinstall

echo "âœ” Python environment ready."

###############################################
#  STEP 4 â€” Install Supervisor (after venv setup)
###############################################

echo "ğŸ“¦ Installing Supervisor..."

if [[ "$OS" == "debian" ]]; then
    SUPERVISOR_DIR="/etc/supervisor/conf.d"
    sudo apt-get update -y
    sudo apt-get install -y supervisor
    sudo systemctl enable supervisor
    sudo systemctl start supervisor
elif [[ "$OS" == "rhel" ]]; then
    SUPERVISOR_DIR="/etc/supervisord.d"
    sudo yum install -y supervisor
    sudo systemctl enable supervisord
    sudo systemctl start supervisord
fi

###############################################
#  STEP 5 â€” Supervisor config + service start
###############################################

echo "ğŸ“ Copying Supervisor config..."
sudo cp "$CONF_SRC" "$SUPERVISOR_DIR/{{ app_name }}.conf"

# Replace placeholder in config with venv python
sudo sed -i "s|__VENV_PYTHON__|$VENV_PATH/bin/python|g" \
    "$SUPERVISOR_DIR/{{ app_name }}.conf"

sudo supervisorctl reread
sudo supervisorctl update

echo "ğŸš€ Starting service..."
supervisorctl restart "{{ app_name }}" || supervisorctl start "{{ app_name }}"

echo "ğŸ‰ Deployment Completed Successfully!"
